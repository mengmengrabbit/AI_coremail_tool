# AI_coremail_tool
# 技术需求文档

**需求编号**：TRD-2025-001  
**版本**：1.0  
**状态**：评审中  

## 1. 引言

### 1.1 背景与动机
当前我公司共申请专利194件，其中授权专利82件、已受理待公布实质审查专利61件、在实质审查流程中专利8件。由于专利审查的时间滞后性，该数量还在逐年增长，流程窗口期也被拉长至两到三年，这都给专利管理增添了较大工作难度；同时逐项专利的受理、审查和授权发放进度由第三方代理机构协助我司与国家知识产权局对接完成，主要交互方式为外网邮件，Coremail 邮件系统是公司内部使用的主要邮件系统，通过 https://mail.cffex.com.cn 访问。目前，员工需要手动处理大量邮件，特别是专利相关邮件，包括审查提醒、授权证书、费用发票等。我司需要在接收邮件后根据专利的不同状态判断接下来的操作，如及时反馈审查修改意见、完成缴费动作、下载授权证书等。这些邮件内容繁杂且同质化程度很高，导致处理过程繁琐，容易遗漏重要信息，且缺乏系统化管理。为避免“信息接收错漏”、“关键信息查找难度大”、“错过专利修改意见答复或缴费的限定时间”等问题，希望开发优化知识产权专用管理系统。它目前主要可解决以下三方面的问题（详参https://cffexcorp.feishu.cn/docx/GkXwdiW3aose6cxPjNUciE9cnK3?from=from_copylink）：
  - 通过“专利审查临期提醒”模块，找出需要答复国知局第一次或第二次审查意见的专利、答复截止时间和当前紧急程度，在截止时间前通知到发明人，减少人工筛查成本；
  - 通过“专利授权证书汇总”模块，可查找已发放的专利授权证书并提供一键下载pdf文件功能，方便公司内需求人员检索和文件归档；
  - 通过“专利费用发票汇总”模块，及时找到新增申请、新增授权专利以及历史延续性专利的缴费凭证，并将缴费凭证进行分类放置，提醒在有效期前完成专利获权的缴费报销动作。

后续期望优化的方向（详参“2.1 功能需求”描述）：
  - 与飞书提醒打通，用于提醒发明人及时进行专利审查意见修改；
  - 用于研发部门进行项目管理时及时收集下载需要的专利证书；
  - 用于财务部门进行发票信息稽核。

### 1.2 目标（量化指标）
- 减少 80% 的邮件手动处理时间
- 提高专利审查提醒响应率至 100%
- 实现 90% 的邮件自动分类准确率
- 降低 90% 的专利临期审查遗漏风险
- 提高发票处理效率 

### 1.3 范围
**包含**：
- Coremail 邮箱自动连接与同步
- 邮件及附件智能分类与归档
- 专利审查提醒自动化处理
- 发票类附件分类与信息提取
- 与飞书多维表格的集成

**不包含**：
- 邮件撰写与回复功能
- 非专利相关邮件的深度处理
- 邮件加密与解密

### 1.4 参考资料
- Coremail API 文档
- 飞书开放平台 API 文档
- 现有 EmailManager 类实现(参考master分支)
- 专利审查流程文档

## 2. 需求详情

### 2.1 功能需求

| 功能ID | 描述 | 输入/输出 | 业务规则 |备注（当前已有--请优化、考虑纳入--待开发） |
|--------|------|-----------|----------|----------|
| F-01 | 邮箱自动连接与同步 | 用户名密码→同步状态 | 支持 IMAP协议，定时自动同步 |可通过申请coremail专用密码和本地outlook客户端连接，进行邮件同步转存|
| F-02 | 邮件智能分类 | 邮件内容→分类结果 | 基于内容和发件人进行分类，支持配置自定义规则 |当前主要需要分三类发件人：info@sptl.com.cn、xxx@kspa.com.cn（后缀）、xxx@softline.org.cn|
| F-03 | 附件自动归档 | 附件→归档路径 | 按附件类型和内容智能归类，支持批量处理 |当前主要支持专利授权证书和专利支付发票分类归档，考虑纳入专利所有过程类文档的分类归档|
| F-04 | 专利审查提醒管理 | 邮件→提醒事项 | 自动提取申请号、期限等信息，按紧急程度分类 |当前主要支持三大场景：“专利审查回复到期提醒”、“专利授权缴费到期提醒”、“专利延续性费用缴纳到期提醒”。可划分为三类紧急程度：已逾期：红色提醒；7天内到期：橙色提醒；其他情况：绿色提醒|
| F-05 | 发票信息提取与汇总 | 发票附件→结构化数据 | 自动识别发票类型，提取金额、税率等信息 |参见F-10|
| F-06 | 临期提醒自动化 | 期限日期→提醒事件 | 设置多级提醒时间点，支持邮件转发和飞书通知 |考虑在特定时间内（首次接收消息时和距离审查截止日1周时间时）自动转发审查通知邮件，并触发数据库变更或飞书多维表格记录变更，自动提醒发明人回复审查意见 |
| F-07 | 飞书多维表格集成 | 专利信息→飞书表格 | 双向同步，支持状态变更触发提醒 |维护多维表格信息准确性，确保触发提醒到准确的人员（排除离职人员的顺位第一发明人）|
| F-08 | 专利证书管理 | 证书附件→证书库 | 自动提取专利号、名称等信息，支持检索 |当前已支持检索专利号、名称等信息并一键下载证书，考虑优化为供公司其他人员可检索下载的界面，增加管理端和分级访问权限（管理员：检索下载全公司证书；项目经理：下载项目组证书；普通员工：下载自己作为发明人的证书）|
| F-09 | 协会通知分类 | 通知邮件→分类结果 | 自动识别评奖评优、活动提醒、服务采购、企业资质证书等不同类型通知 |当前主要分类四类：评奖评优、活动提醒、服务采购、企业资质证书，考虑纳入更多通知分类|
| F-10 | 费用合计计算 | 多发票→汇总报表 | 支持按专利、时间段等维度统计费用 |考虑纳入两个功能：根据时间范围筛选出一段时间内的发票，进行税前税后费用总计；根据专利名筛选出特定专利发票，进行税前税后费用总计|

### 2.2 非功能需求

- **性能**：
  - 邮件同步速度≥100封/分钟
  - 附件处理速度≥50MB/分钟
  - Web界面响应时间≤500ms

- **安全**：
  - HTTPS传输
  - 用户权限分级控制

- **可靠性**：
  - 系统可用性≥99.5%
  - 数据备份与恢复机制
  - 同步失败自动重试

- **兼容性**：
  - 支持Chrome/Firefox/Edge等最新版浏览器访问
  - 支持Windows/macOS/信创？操作系统
  - 支持移动端访问

- **可扩展性**：
  - 支持多用户并发使用
  - 模块化设计，便于功能扩展
  - 支持API接口调用

## 3. 技术方案

### 3.1 架构图
- **技术架构图**：
  ![image-alt-text](https://github.com/mengmengrabbit/AI_coremail_tool/blob/main/%E5%BD%93%E5%89%8D%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84%E5%9B%BE.png)

- **流程图**：
  ![image-alt-text](https://github.com/mengmengrabbit/AI_coremail_tool/blob/main/%E6%B5%81%E7%A8%8B%E5%9B%BE.png)

### 3.2 技术栈(当前用到，可改)

- **后端**：Python + Flask
- **数据库**：SQLite (本地存储)
- **邮件处理**：imaplib, poplib, smtplib, email
- **文本处理**：NLTK, jieba, re
- **AI分类**：scikit-learn, LLM API
- **定时任务**：APScheduler
- **前端**：HTML + CSS + JavaScript + Bootstrap
- **API集成**：Requests, 飞书开放平台SDK

### 3.3 数据库设计

**邮件表 (emails)**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| message_id | TEXT | 邮件唯一ID |
| subject | TEXT | 邮件主题 |
| from_addr | TEXT | 发件人 |
| date | DATETIME | 邮件日期 |
| category | TEXT | 分类结果 |
| content_hash | TEXT | 内容哈希值 |
| file_path | TEXT | 本地存储路径 |
| processed | BOOLEAN | 处理状态 |

**专利提醒表 (patent_reminders)**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| email_id | INTEGER | 关联邮件ID |
| application_no | TEXT | 专利申请号 |
| client_no | TEXT | 客户编号 |
| our_no | TEXT | 我方编号 |
| deadline | DATE | 截止日期 |
| urgency_level | TEXT | 紧急程度 |
| completed | BOOLEAN | 完成状态 |
| notify_status | TEXT | 通知状态 |

**发票表 (invoices)**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| email_id | INTEGER | 关联邮件ID |
| invoice_number | TEXT | 发票编号 |
| invoice_type | TEXT | 发票类型 |
| pre_tax_amount | DECIMAL | 税前金额 |
| tax_rate | DECIMAL | 税率 |
| tax_amount | DECIMAL | 税额 |
| total_amount | DECIMAL | 总金额 |
| file_path | TEXT | 文件路径 |

**附件表 (attachments)**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| email_id | INTEGER | 关联邮件ID |
| filename | TEXT | 原始文件名 |
| file_type | TEXT | 文件类型 |
| category | TEXT | 分类 |
| saved_path | TEXT | 保存路径 |
| extracted | BOOLEAN | 信息提取状态 |

**飞书集成表 (feishu_integration)**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| patent_id | INTEGER | 专利申请号 |
| first_author | TEXT | 专利第一发明人（仍在职） |
| feishu_record_id | TEXT | 飞书记录ID |
| last_sync_time | DATETIME | 最后同步时间(变更触发消息提醒) |
| sync_patent_status | TEXT | 同步专利状态(变更触发消息提醒) |

## 4. 验收标准

### 4.1 测试用例

| 测试ID | 测试内容 | 预期结果 |
|--------|----------|----------|
| T-01 | 邮箱连接与同步 | 成功连接邮箱并同步最新邮件 |
| T-02 | 邮件分类准确性 | 分类准确率≥95% |
| T-03 | 专利提醒提取 | 正确提取申请号、期限等信息 |
| T-04 | 发票信息提取 | 准确识别发票类型并提取金额信息 |
| T-05 | 临期提醒功能 | 按设定时间点触发提醒 |
| T-06 | 飞书集成 | 数据成功同步至飞书多维表格 |
| T-07 | 证书获取 | 附件中的证书成功提取并支持一键下载（进阶需求：分权限管控） |
| T-08 | 费用合计计算 | 多发票汇总计算结果准确 |
| T-09 | 系统性能 | 满足性能指标要求 |

### 4.2 性能指标

- 邮件同步速度≥100封/分钟
- 附件处理速度≥50MB/分钟
- Web界面响应时间≤500ms
- 系统CPU占用率≤30%
- 内存占用≤500MB

## 5. 项目计划

| 阶段 | 起止日期 | 负责人 |
|------|----------|--------|
| 需求分析与设计 | 2025-07-01~2025-07-04 | 项目经理 |
| 邮箱连接与同步模块 | 2025-07-07~2025-07-11 | 后端开发 |
| 邮件分类与附件归档 | 2025-07-14~2025-07-28 | 算法工程师 |
| 专利提醒与发票处理 | 2025-07-28~2025-08-11 | 后端开发 |
| 飞书集成与通知 | 2025-08-11~2025-08-18 | 集成工程师 |
| Web界面开发 | 2025-08-11~2025-08-25 | 前端开发 |
| 系统测试 | 2025-08-25~2025-08-29 | 测试工程师 |
| 用户验收测试 | 2025-09 | 项目经理 |
| 部署上线 | 2025-10 | 运维工程师 |

## 6. 附录

### 6.1 风险分析表

| 风险ID | 风险描述 | 可能性 | 影响 | 缓解措施 |
|--------|----------|--------|------|----------|
| R-01 | 邮箱服务器不稳定 | 中 | 高 | 实现断点续传，失败重试机制 |
| R-02 | 邮件格式多样导致解析错误 | 高 | 中 | 增强解析算法，添加异常处理 |
| R-03 | 飞书API变更 | 低 | 高 | 模块化设计，快速适配新API |
| R-04 | 性能瓶颈 | 中 | 中 | 优化算法，实现邮件增量快速同步解析 |

### 6.2 术语表

| 术语 | 定义 |
|------|------|
| Coremail | 公司使用的邮件系统 |
| IMAP | 邮件接收协议 |
| SMTP | 邮件发送协议 |
| 专利申请号 | 专利的唯一标识号 |
| 临期提醒 | 专利一审及二审的审查期限临近，由代理机构代替国知局发送的提醒邮件，包含官方审查意见和代理针对审查意见给出的修改版本pdf文件 |
| 飞书多维表格 | 飞书提供的在线协作表格工具 |
| 发票类型 | 包括官方票据、代理票据、代理XML文件、国家知识产权局的缴费通知和代理的缴费收据等pdf文件 |
